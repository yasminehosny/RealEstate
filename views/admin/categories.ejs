<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Categories</title>
  <link rel="stylesheet" href="/all.css">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2><i class="fa-solid fa-gauge"></i> Admin Panel</h2>
      </div>
      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item">
          <i class="fa-solid fa-chart-line"></i>
          <span>Dashboard</span>
        </a>
        <a href="/admin/users" class="nav-item">
          <i class="fa-solid fa-users"></i>
          <span>Users</span>
        </a>
        <a href="/admin/properties" class="nav-item">
          <i class="fa-solid fa-building"></i>
          <span>Properties</span>
        </a>
        <a href="/admin/bookings" class="nav-item">
          <i class="fa-solid fa-calendar-check"></i>
          <span>Bookings</span>
        </a>
        <a href="/admin/categories" class="nav-item active">
          <i class="fa-solid fa-layer-group"></i>
          <span>Categories</span>
        </a>
        <a href="/admin/feedbacks" class="nav-item">
          <i class="fa-solid fa-comments"></i>
          <span>Feedbacks</span>
        </a>
        <a href="/admin/messages" class="nav-item">
          <i class="fa-solid fa-envelope"></i>
          <span>Messages</span>
        </a>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="page-header">
        <div class="page-header-left">
          <h1><i class="fa-solid fa-layer-group"></i> Categories Management</h1>
          <p>Manage property categories in the platform</p>
        </div>
        <div class="page-header-right">
          <button class="btn btn-primary" onclick="openAddCategoryModal()">
            <i class="fa-solid fa-plus"></i> Add Category
          </button>
          <button class="btn btn-outline" onclick="location.reload()">
            <i class="fa-solid fa-rotate"></i> Refresh
          </button>
          <form method="post" action="/admin/logout" style="display:inline;">
            <button class="btn btn-danger" type="submit">
              <i class="fa-solid fa-right-from-bracket"></i> Logout
            </button>
          </form>
        </div>
      </div>

      <% if (typeof success !== 'undefined' && success) { %>
        <div id="successAlert" class="alert alert-success" style="margin: 24px auto; max-width: 600px; text-align: center; font-weight: bold; background: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 6px; box-shadow: 0 8px 24px rgba(40,167,69,0.15); transform: translateY(-40px); opacity: 0; transition: all 0.5s cubic-bezier(.68,-0.55,.27,1.55);">
          <i class="fa-solid fa-check-circle" style="margin-right:8px;"></i> <%= success %>
        </div>
        <script>
          window.addEventListener('DOMContentLoaded', function() {
            var alert = document.getElementById('successAlert');
            if(alert) {
              setTimeout(function() {
                alert.style.transform = 'translateY(0)';
                alert.style.opacity = '1';
              }, 100);
              setTimeout(function() {
                alert.style.transform = 'translateY(-40px)';
                alert.style.opacity = '0';
              }, 3100);
              setTimeout(function() {
                alert.remove();
              }, 3700);
            }
          });
        </script>
      <% } %>

      <div class="content-card">
        <div class="table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Description</th>
                <th>Properties Count</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% categories.forEach(category => { %>
                <tr>
                  <td>
                    <div class="category-info">
                      <div class="category-icon">
                        <i class="fa-solid fa-layer-group"></i>
                      </div>
                      <div class="category-details">
                        <span class="category-name"><%= category.name %></span>
                      </div>
                    </div>
                  </td>
                  <td><%= category.description || 'No description' %></td>
                  <td>
                    <span class="count-badge"><%= category.propertiesCount || 0 %></span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <a class="btn-icon" title="View Properties" href="/property/allproperties?category_name=<%= encodeURIComponent(category.name) %>" target="_blank">
                        <i class="fa-solid fa-eye"></i>
                      </a>
                      <button class="btn-icon" title="Edit Category" onclick="openEditCategoryModal('<%= category._id %>')">
                        <i class="fa-solid fa-edit"></i>
                      </button>
                      <form method="POST" action="/admin/categories/<%= category._id %>/delete" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this category?');">
                        <button class="btn-icon btn-danger" title="Delete Category" type="submit">
                          <i class="fa-solid fa-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Category Modal -->
  <div id="addCategoryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Category</h3>
        <button class="modal-close" onclick="closeAddCategoryModal()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <form class="modal-form" action="/admin/categories/add" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label>Category Name</label>
          <input type="text" name="name" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea name="description" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Image</label>
          <input type="file" name="image" accept="image/*" required>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-outline" onclick="closeAddCategoryModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Category</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div id="editCategoryModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Category</h3>
        <button class="modal-close" onclick="closeEditCategoryModal()">
          <i class="fa-solid fa-times"></i>
        </button>
      </div>
      <form id="editCategoryForm" class="modal-form" action="/admin/categories/edit" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="_id" id="editCategoryId">
        <div class="form-group">
          <label>Category Name</label>
          <input type="text" name="name" id="editCategoryName" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea name="description" id="editCategoryDescription" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Image (leave blank to keep current)</label>
          <input type="file" name="image" accept="image/*">
          
          <div id="currentCategoryImage" style="margin-top:8px;"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-outline" onclick="closeEditCategoryModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function openAddCategoryModal() {
      document.getElementById('addCategoryModal').style.display = 'flex';
    }

    function closeAddCategoryModal() {
      document.getElementById('addCategoryModal').style.display = 'none';
    }

    function openEditCategoryModal(id) {
      // ابحث عن بيانات الكاتيجوري في الجدول
      const row = [...document.querySelectorAll('tr')].find(tr => tr.innerHTML.includes(`openEditCategoryModal('${id}')`));
      if (!row) return;
      const name = row.querySelector('.category-name').textContent.trim();
      const description = row.children[1].textContent.trim();
      const imgDiv = document.getElementById('currentCategoryImage');
      // جلب الصورة من السيرفر (اختياري)
      imgDiv.innerHTML = '';
      <% categories.forEach(category => { %>
        if ('<%= category._id %>' === id && '<%= category.image %>') {
          imgDiv.innerHTML = `<img src="/uploads/<%= category.image %>" alt="Current Image" style="max-width:80px;max-height:80px;border-radius:8px;">`;
        }
      <% }); %>
      document.getElementById('editCategoryId').value = id;
      document.getElementById('editCategoryName').value = name;
      document.getElementById('editCategoryDescription').value = description === 'No description' ? '' : description;
      document.getElementById('editCategoryModal').style.display = 'flex';
    }

    function closeEditCategoryModal() {
      document.getElementById('editCategoryModal').style.display = 'none';
    }
  </script>
</body>
</html> 